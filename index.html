<!DOCTYPE html>
<html>
<head>
    <title>CTDOT Pedestrian Demand Model</title>
    <script src="https://unpkg.com/deck.gl@8.9.27/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/google-maps@8.9.27/dist.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        .info-box {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 280px;
        }
        
        .loading-status {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #0066cc;
            width: 0%;
            transition: width 0.3s;
        }
        
        .filters {
            margin-top: 15px;
        }
        
        .demand-slider {
            width: 100%;
            margin: 5px 0;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .legend h4 { margin: 0 0 10px; font-size: 16px; }
        .legend div { padding: 3px 0; font-size: 14px; }
        .legend span {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #666;
            vertical-align: middle;
            border-radius: 4px;
        }
        
        /* Make sure Street View controls are visible */
        .gm-svpc {
            z-index: 1001 !important;
        }
        
        /* Coordinate system selection */
        .coord-system {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .coord-system select {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-box">
        <h3>Pedestrian Demand Model</h3>
        <div>Total Points: <span id="totalPoints">Loading...</span></div>
        <div class="loading-status" id="loadingStatus">Loading data from Google Cloud Storage...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="filters">
            <h4>Filter by Demand Rank</h4>
            <div>
                <input type="range" class="demand-slider" id="rankMin" min="1" max="10" value="1">
                <input type="range" class="demand-slider" id="rankMax" min="1" max="10" value="10">
                <div>Range: <span id="rankRangeDisplay">1-10</span></div>
            </div>
        </div>
        
        <div class="coord-system">
            <h4>Coordinate System</h4>
            <select id="coordSystem" onchange="updateCoordinateSystem()">
                <option value="wgs84">WGS84 (Latitude/Longitude)</option>
                <option value="nad83_ct" selected>NAD83 Connecticut State Plane (ft)</option>
                <option value="nad83_ct_meters">NAD83 Connecticut State Plane (m)</option>
                <option value="swap">Swap X/Y Coordinates</option>
            </select>
        </div>
    </div>
    
    <div class="legend">
        <h4>Demand Rank</h4>
        <div><span style="background: #fee0d2;"></span>8-10 (High)</div>
        <div><span style="background: #fcbba1;"></span>6-7 (Medium-High)</div>
        <div><span style="background: #fb6a4a;"></span>4-5 (Medium)</div>
        <div><span style="background: #67000d;"></span>1-3 (Low)</div>
    </div>
    
    <script>
        let pointsData = [];
        let originalPointsData = [];
        let deckOverlay;
        let map;
        
        // Define coordinate system transformations
        // NAD83 Connecticut State Plane (ft)
        proj4.defs('EPSG:2234', '+proj=lcc +lat_1=41.2 +lat_2=41.86666666666667 +lat_0=40.83333333333334 +lon_0=-72.75 +x_0=304800 +y_0=152400 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs');
        
        // NAD83 Connecticut State Plane (m)
        proj4.defs('EPSG:6433', '+proj=lcc +lat_1=41.2 +lat_2=41.86666666666667 +lat_0=40.83333333333334 +lon_0=-72.75 +x_0=304800 +y_0=152400 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
        
        // WGS84
        proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');
        
        function getColor(rank) {
            if (rank <= 3) return [103, 0, 13, 220];    // Low - dark red
            if (rank <= 5) return [251, 106, 74, 220];  // Medium - orange
            if (rank <= 7) return [252, 187, 161, 220]; // Medium-High - light orange
            return [254, 224, 210, 220];                // High - light pink
        }
        
        function initialize() {
            // Create Google Map
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 41.6, lng: -72.7 },
                zoom: 9,
                mapTypeId: 'satellite',
                mapTypeControl: true,
                mapTypeControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                // Ensure Street View controls are visible and functioning
                streetViewControl: true,
                streetViewControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_TOP
                }
            });
            
            // Add event listener for Street View mode changes
            const streetViewListener = map.addListener('streetview_changed', function() {
                // When entering or exiting Street View mode, ensure UI elements stay visible
                const panorama = map.getStreetView();
                if (panorama.getVisible()) {
                    // In Street View mode - ensure "Back to Map" button is visible
                    panorama.controls[google.maps.ControlPosition.TOP_RIGHT].push(
                        createBackToMapButton(panorama)
                    );
                }
            });
            
            // Load data from Google Cloud Storage
            loadDataFromGCS();
        }
        
        // Create a custom "Back to Map" button for Street View
        function createBackToMapButton(panorama) {
            const backButton = document.createElement('button');
            backButton.textContent = 'Back to Map';
            backButton.style.backgroundColor = 'white';
            backButton.style.color = 'black';
            backButton.style.border = '1px solid #ccc';
            backButton.style.borderRadius = '4px';
            backButton.style.padding = '8px 12px';
            backButton.style.margin = '10px';
            backButton.style.cursor = 'pointer';
            backButton.style.fontFamily = 'Arial, sans-serif';
            backButton.style.fontSize = '14px';
            
            backButton.addEventListener('click', function() {
                panorama.setVisible(false);
            });
            
            return backButton;
        }
        
        async function loadDataFromGCS() {
            const loadingStatus = document.getElementById('loadingStatus');
            const progressFill = document.getElementById('progressFill');
            
            try {
                loadingStatus.textContent = "Loading data from Google Cloud Storage...";
                progressFill.style.width = "10%";
                
                // Fetch the data from Google Cloud Storage
                const response = await fetch("https://storage.googleapis.com/pedestrian-demand-data/milepoints_data.json");
                
                // Check if the request was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Start reading the response as it comes in
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                
                let receivedLength = 0;
                let chunks = [];
                
                // Read the data chunks as they arrive
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        break;
                    }
                    
                    chunks.push(value);
                    receivedLength += value.length;
                    
                    // Update the progress bar
                    if (contentLength) {
                        const progress = Math.round((receivedLength / contentLength) * 100);
                        progressFill.style.width = `${progress}%`;
                        loadingStatus.textContent = `Loading data: ${progress}%`;
                    }
                }
                
                // Combine the chunks into a single Uint8Array
                let chunksAll = new Uint8Array(receivedLength);
                let position = 0;
                for (let chunk of chunks) {
                    chunksAll.set(chunk, position);
                    position += chunk.length;
                }
                
                // Convert to a string
                const text = new TextDecoder("utf-8").decode(chunksAll);
                
                // Parse the JSON
                originalPointsData = JSON.parse(text);
                
                // Update total points counter
                document.getElementById('totalPoints').textContent = originalPointsData.length.toLocaleString();
                
                // Update loading status
                loadingStatus.textContent = "Data loaded successfully!";
                progressFill.style.width = "100%";
                
                // Apply coordinate transformation based on the selected system
                updateCoordinateSystem();
                
            } catch (error) {
                console.error('Error loading data:', error);
                loadingStatus.textContent = `Error loading data: ${error.message}`;
                progressFill.style.width = "100%";
                progressFill.style.backgroundColor = "#ff3333";
            }
        }
        
        function updateCoordinateSystem() {
            const system = document.getElementById('coordSystem').value;
            
            if (!originalPointsData || originalPointsData.length === 0) {
                return;
            }
            
            pointsData = originalPointsData.map(point => {
                const newPoint = {...point};
                
                // Get original position
                const origX = point.position[0];
                const origY = point.position[1];
                
                // Transform based on selected coordinate system
                if (system === 'wgs84') {
                    // Assume data is already in WGS84
                    newPoint.position = [origX, origY];
                }
                else if (system === 'nad83_ct') {
                    // Convert from NAD83 Connecticut State Plane (ft) to WGS84
                    const result = proj4('EPSG:2234', 'EPSG:4326', [origX, origY]);
                    newPoint.position = result;
                }
                else if (system === 'nad83_ct_meters') {
                    // Convert from NAD83 Connecticut State Plane (m) to WGS84
                    const result = proj4('EPSG:6433', 'EPSG:4326', [origX, origY]);
                    newPoint.position = result;
                }
                else if (system === 'swap') {
                    // Sometimes coordinates are in [y, x] order instead of [x, y]
                    newPoint.position = [origY, origX];
                }
                
                return newPoint;
            });
            
            // Update the visualization
            createDeckLayer();
            
            // Center map on Connecticut
            map.setCenter({ lat: 41.6, lng: -72.7 });
            map.setZoom(9);
        }
        
        function createDeckLayer() {
            const filteredData = filterData();
            
            const scatterLayer = new deck.ScatterplotLayer({
                id: 'demand-points',
                data: filteredData,
                getPosition: d => d.position,
                getFillColor: d => getColor(d.DemandRank),
                getRadius: d => d.DemandRank * 50,
                radiusMinPixels: 2,
                radiusMaxPixels: 20,
                pickable: true,
                opacity: 0.8,
                stroked: true,
                lineWidthMinPixels: 1,
                getLineColor: [255, 255, 255, 100],
                onClick: info => {
                    if (info.object) {
                        alert(
                            `Route: ${info.object.route_id}\n` +
                            `Milepoint: ${info.object.begin_poin}\n` +
                            `Demand Rank: ${info.object.DemandRank}\n` +
                            `Town: ${info.object.town}\n` +
                            `Sidewalks: ${info.object.Sidewalks ? 'Yes' : 'No'}`
                        );
                    }
                }
            });
            
            if (deckOverlay) {
                deckOverlay.setProps({ layers: [scatterLayer] });
            } else {
                deckOverlay = new deck.GoogleMapsOverlay({ layers: [scatterLayer] });
                deckOverlay.setMap(map);
            }
        }
        
        function filterData() {
            const minRank = parseInt(document.getElementById('rankMin').value);
            const maxRank = parseInt(document.getElementById('rankMax').value);
            
            return pointsData.filter(point => {
                return point.DemandRank >= minRank && point.DemandRank <= maxRank;
            });
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const rangeInputs = document.querySelectorAll('.demand-slider');
            rangeInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const min = document.getElementById('rankMin').value;
                    const max = document.getElementById('rankMax').value;
                    document.getElementById('rankRangeDisplay').textContent = `${min}-${max}`;
                    createDeckLayer();
                });
            });
        });
        
        // Function to check if Google Maps is loaded
        function waitForGoogleMaps() {
            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                initialize();
            } else {
                setTimeout(waitForGoogleMaps, 100);
            }
        }
        
        // Initialize when Google Maps is ready
        if (document.readyState === 'complete') {
            waitForGoogleMaps();
        } else {
            window.addEventListener('load', waitForGoogleMaps);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRG2xII3nH7HJkp08TKpssRgLkf0OjMBQ&libraries=visualization"></script>
</body>
</html>
