<!DOCTYPE html>
<html>
<head>
    <title>CTDOT Pedestrian Demand Model</title>
    <script src="https://unpkg.com/deck.gl@8.9.27/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/google-maps@8.9.27/dist.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

    <style>
        /* CSS styles remain the same */
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .info-box { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; max-width: 280px; }
        .loading-status { margin-top: 5px; font-size: 14px; color: #666; }
        .progress-bar { width: 100%; height: 10px; background-color: #eee; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: #0066cc; width: 0%; transition: width 0.3s; }
        .filters { margin-top: 15px; }
        .demand-slider { width: 100%; margin: 5px 0; }
        .legend { position: absolute; bottom: 30px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; }
        .legend h4 { margin: 0 0 10px; font-size: 16px; }
        .legend div { padding: 3px 0; font-size: 14px; }
        .legend span { display: inline-block; width: 20px; height: 20px; margin-right: 8px; border: 1px solid #666; vertical-align: middle; border-radius: 4px; }
        .gm-svpc { z-index: 1001 !important; }
        .coord-system { margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; }
        .coord-system select { width: 100%; padding: 5px; margin-top: 5px; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-box">
        <h3>Pedestrian Demand Model</h3>
        <div>Total Points: <span id="totalPoints">Loading...</span></div>
        <div class="loading-status" id="loadingStatus">Initializing...</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="filters">
            <h4>Filter by Demand Rank</h4>
            <div>
                <input type="range" class="demand-slider" id="rankMin" min="1" max="10" value="1">
                <input type="range" class="demand-slider" id="rankMax" min="1" max="10" value="10">
                <div>Range: <span id="rankRangeDisplay">1-10</span></div>
            </div>
        </div>
        <div class="coord-system">
            <h4>Coordinate System</h4>
            <select id="coordSystem" onchange="updateCoordinateSystem()">
                <option value="wgs84">WGS84 (Latitude/Longitude)</option>
                <option value="nad83_ct" selected>NAD83 Connecticut State Plane (ft)</option>
                <option value="nad83_ct_meters">NAD83 Connecticut State Plane (m)</option>
                <option value="swap">Swap X/Y Coordinates</option>
            </select>
        </div>
    </div>
    <div class="legend">
        <h4>Demand Rank</h4>
        <div><span style="background: rgb(254, 224, 210);"></span>8-10 (High)</div>
        <div><span style="background: rgb(252, 187, 161);"></span>6-7 (Medium-High)</div>
        <div><span style="background: rgb(251, 106, 74);"></span>4-5 (Medium)</div>
        <div><span style="background: rgb(103, 0, 13);"></span>1-3 (Low)</div>
    </div>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRG2xII3nH7HJkp08TKpssRgLkf0OjMBQ&libraries=visualization"></script>

    <script>
        let pointsData = []; // Transformed data for display
        let originalPointsData = []; // Raw data loaded from GCS
        let deckOverlay;
        let map;

        // Coordinate System Definitions (proj4.defs)
        proj4.defs('EPSG:2234', '+proj=lcc +lat_1=41.2 +lat_2=41.86666666666667 +lat_0=40.83333333333334 +lon_0=-72.75 +x_0=304800 +y_0=152400 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs');
        proj4.defs('EPSG:6433', '+proj=lcc +lat_1=41.2 +lat_2=41.86666666666667 +lat_0=40.83333333333334 +lon_0=-72.75 +x_0=304800 +y_0=152400 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs');
        proj4.defs('EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs');

        // GCS Data URL
        const dataUrl = "https://storage.googleapis.com/pedestrian-demand-data/milepoints_data.json";

        // Color function
        function getColor(rank) { /* ... same as before ... */
            if (rank <= 3) return [103, 0, 13, 220];
            if (rank <= 5) return [251, 106, 74, 220];
            if (rank <= 7) return [252, 187, 161, 220];
            return [254, 224, 210, 220];
         }

        // Initialize Google Map and Deck.gl Overlay
        function initialize() {
            // Check if google.maps is loaded before proceeding
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API not loaded yet. Retrying...");
                setTimeout(initialize, 200); // Try again shortly
                return;
            }
            console.log("Google Maps API ready. Initializing map...");
            document.getElementById('loadingStatus').textContent = "Initializing map...";

            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 41.6, lng: -72.7 },
                zoom: 9,
                mapTypeId: 'satellite',
                mapTypeControl: true,
                mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },
                streetViewControl: true,
                streetViewControlOptions: { position: google.maps.ControlPosition.RIGHT_TOP }
            });

            // Street View listener (optional refinement)
            map.addListener('streetview_changed', () => { /* ... */ });

            // Load data from GCS
            loadDataFromGCS();
        }

        // Load data from GCS function (async function loadDataFromGCS()...)
        async function loadDataFromGCS() { /* ... same as before ... */
            const loadingStatus = document.getElementById('loadingStatus');
            const progressFill = document.getElementById('progressFill');
            const totalPointsSpan = document.getElementById('totalPoints');
            try {
                loadingStatus.textContent = "Fetching data from GCS...";
                totalPointsSpan.textContent = "Fetching...";
                progressFill.style.width = "5%";
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} - Check GCS permissions and CORS settings.`);
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0;
                let chunks = [];
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    if (contentLength) {
                        const progress = Math.round((receivedLength / contentLength) * 100);
                        progressFill.style.width = `${progress}%`;
                        loadingStatus.textContent = `Loading data: ${progress}%`;
                    } else {
                         loadingStatus.textContent = `Loading data: ${Math.round(receivedLength / 1024 / 1024)} MB received`;
                    }
                }
                loadingStatus.textContent = "Processing data...";
                progressFill.style.width = `100%`;
                let chunksAll = new Uint8Array(receivedLength);
                let position = 0;
                for (let chunk of chunks) { chunksAll.set(chunk, position); position += chunk.length; }
                const text = new TextDecoder("utf-8").decode(chunksAll);
                originalPointsData = JSON.parse(text);
                totalPointsSpan.textContent = originalPointsData.length.toLocaleString();
                loadingStatus.textContent = "Data loaded. Applying coordinates...";
                updateCoordinateSystem();
            } catch (error) {
                console.error('Error loading or processing data:', error);
                loadingStatus.textContent = `Error: ${error.message}`;
                totalPointsSpan.textContent = "Error";
                progressFill.style.width = "100%";
                progressFill.style.backgroundColor = "#ff3333";
            }
         }

        // Update coordinate system function (function updateCoordinateSystem()...)
        function updateCoordinateSystem() { /* ... same as before ... */
            const system = document.getElementById('coordSystem').value;
            const loadingStatus = document.getElementById('loadingStatus');
            loadingStatus.textContent = "Applying coordinate system...";
            if (!originalPointsData || originalPointsData.length === 0) { loadingStatus.textContent = "No data to transform."; return; }
            setTimeout(() => {
                 try {
                    pointsData = originalPointsData.map(point => {
                        const newPoint = { ...point };
                        const origX = point.position[0];
                        const origY = point.position[1];
                        let transformedPosition = null;
                        if (system === 'wgs84') { transformedPosition = [origX, origY]; }
                        else if (system === 'nad83_ct') { transformedPosition = proj4('EPSG:2234', 'EPSG:4326', [origX, origY]); }
                        else if (system === 'nad83_ct_meters') { transformedPosition = proj4('EPSG:6433', 'EPSG:4326', [origX, origY]); }
                        else if (system === 'swap') { transformedPosition = [origY, origX]; }
                        if (transformedPosition && !isNaN(transformedPosition[0]) && !isNaN(transformedPosition[1])) {
                             newPoint.position = transformedPosition; return newPoint;
                        } else { return null; }
                    }).filter(p => p !== null);
                    loadingStatus.textContent = "Coordinates applied. Updating map...";
                    createDeckLayer();
                    loadingStatus.textContent = "Map updated.";
                 } catch (error) {
                     console.error("Error during coordinate transformation:", error);
                     loadingStatus.textContent = `Error transforming coordinates: ${error.message}`;
                 }
             }, 10);
        }

        // Create Deck layer function (function createDeckLayer()...)
        function createDeckLayer() { /* ... same as before, using infoWindow ... */
            const filteredData = filterData();
            const scatterLayer = new deck.ScatterplotLayer({
                id: 'demand-points', data: filteredData, getPosition: d => d.position,
                getFillColor: d => getColor(d.DemandRank), getRadius: 15, radiusUnits: 'meters',
                radiusMinPixels: 2, radiusMaxPixels: 20, pickable: true, opacity: 0.7,
                stroked: false,
                onClick: ({object, x, y}) => {
                    if (object) {
                        const infoContent = `<strong>Route:</strong> ${object.route_id}<br><strong>Milepoint:</strong> ${object.begin_poin}<br><strong>Demand Rank:</strong> ${object.DemandRank}<br><strong>Town:</strong> ${object.town}<br><strong>Sidewalks:</strong> ${object.Sidewalks ? 'Yes' : 'No'}<hr><strong>Coords (Lon, Lat):</strong> ${object.position[0].toFixed(6)}, ${object.position[1].toFixed(6)}`;
                        const infoWindow = new google.maps.InfoWindow({ content: infoContent, position: { lat: object.position[1], lng: object.position[0] } });
                        infoWindow.open(map);
                    }
                }
            });
             if (deckOverlay) { deckOverlay.setProps({ layers: [scatterLayer] }); }
             else { deckOverlay = new deck.GoogleMapsOverlay({ layers: [scatterLayer] }); deckOverlay.setMap(map); }
        }

        // Filter data function (function filterData()...)
        function filterData() { /* ... same as before ... */
            const minRank = parseInt(document.getElementById('rankMin').value);
            const maxRank = parseInt(document.getElementById('rankMax').value);
            if (!pointsData) return [];
            return pointsData.filter(point => point.DemandRank >= minRank && point.DemandRank <= maxRank);
         }

        // Event Listeners for sliders
        document.addEventListener('DOMContentLoaded', () => { /* ... same as before ... */
             const rangeInputs = document.querySelectorAll('.demand-slider');
             const rankMinInput = document.getElementById('rankMin');
             const rankMaxInput = document.getElementById('rankMax');
             const rankDisplay = document.getElementById('rankRangeDisplay');
             function updateSliderDisplay() {
                 const min = rankMinInput.value; const max = rankMaxInput.value;
                 if (parseInt(min) > parseInt(max)) { if (this.id === 'rankMin') { rankMaxInput.value = min; } else { rankMinInput.value = max; } }
                 rankDisplay.textContent = `${rankMinInput.value}-${rankMaxInput.value}`; createDeckLayer();
             }
             rangeInputs.forEach(input => { input.addEventListener('input', updateSliderDisplay); });
             updateSliderDisplay(); // Initialize

             // *** Start initialization AFTER the DOM is ready and main script runs ***
             initialize();
         });

    </script>

</body>
</html>
